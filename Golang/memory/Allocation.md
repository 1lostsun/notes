### Аллокация - процесс выделения памяти под переменные, структуры, объекты и тд.

Основной аллокатор работает с последовательностью страниц.

Малые размеры выделений (до 32 КБ включительно) округляются до одного из примерно 70 классов размеров. Каждый класс имеет собственный набор объектов строго этого размера.

Любая свободная страница памяти может быть разделена на набор объектов одного размерного класса, которые затем управляются с помощью битовой карты свободных ячеек. 

---
### Основные структуры данных аллокатора:

-  `{go} fixalloc` - аллокатор на основе свободного списка для объектов фиксированного размера вне кучи; используется для управления служебной памятью самого аллокатора.

```go
type fixalloc struct {  
  size   uintptr  
  first  func(arg, p unsafe.Pointer) // При первом вызове возвращается указатель
  arg    unsafe.Pointer  
  list   *mlink  
  chunk  uintptr // использует uintptr вместо unsafe.Pointer, чтобы избежать барьеров записи  
  nchunk uint32  // количество байт, оставшихся в этом блоке 
  nalloc uint32  // размер новых чанков в байтах  
  inuse  uintptr // количество байт, используемых прямо сейчас
  stat   *sysMemStat  
  zero   bool // флаг обнуления выделенной памяти
  }
```

-  [`{go} mheap`](Heap) - куча `{go} malloc`, управляемая с точностью до страницы (8192 байта).
- `{go} mcentral` - хранит все `{go} spans` определенного класса размера.

```go 
// Центральный список свободных объектов заданного размера.
type mcentral struct {
	_ sys.NotInHeap
	
	/* 
	Partial и full содержат два набора объектов mspan:
	один набор - это уже очищенные (swept) используемые блоки,
	другой - еще не очищенные (unswept) используемые блоки.
	Эти два набора меняются ролями в каждом цикле сборки мусора (GC).
	
	Набор неочищенных блоков освобождается либо при выделении новой памяти,
	либо фоновым сборщиком мусора в каждом цикле GC,
	поэтому достаточно двух ролей.
	
	sweepgen увеличивается на 2 в каждом цикле сборки мусора (GC).
	Таким образом, очищенные (swept) блоки находятся в partial[sweepgen / 2 % 2], 
	а неочищенные в partial[1 - sweepgen / 2 % 2].
	
	Процесс очистки (sweeping) извлекает неочищенные блоки из набора неочищенных
	и помещает блоки, которые все еще используются в набор очищенных. 
	Аналогично, при выделении используемого блока он помещается в набор очищенных.
	
	Некоторые части сборщика мусора (sweeper) могут очищать произвольные блоки, 
	и следовательно, не могут удалять их из набора неочищенных (unswept) блоков,
	но при этом добавляют блок в соответствующий список очищенных (swept).
	*/
	
	partial [2]spanSet // список блоков (spans), содержащих свободный объект.
	full    [2]spanSet // список блоков (spans), не содержащих свободный объект.
```

-  `{go} mcache` - кэш `{go} mspan` с незанятым пространством для каждого P (процессора `{go} Go`).

```go
Кэш для малых объектов на каждый поток 
(в Go - на каждый P).

Включает в себя кэш малых объектов 
и статистику локальных выделений.

Блокировки не требуются,
тк кэш относится к отдельному потоку (per-P).

Обхекты mcache выделяются из памяти, 
не управляемой сборщиком мусора (non GC memory),
поэтому любые указатели на кучу 
должны обрабатываться особым образом.

type mcache struct {
	_ sys.NotInHeap
	
	// Следующие поля используются при каждом вызове malloc,
	// поэтому они сгруппированы здесь для улучшения кеширования.
	
	nextSample  int64   // Триггер для срабатывания выборки кучи,
					    // (heap sample) после выделения 
					    // определенного количества байт.
					    
	memProfRate int     // Закэшированное значение 
					    // частоты профиллирования памяти,
					    // используется для обнаружения изменений.
					    
	scanAlloc   uintptr // Количество байт, выделенной области кучи,
						// подлежащей сканированию.
						
	/*
		Кэш аллокатора для "крошечных" объектов без указателей.
		
		tiny - указывает на начало текущего блока "крошечных" объектов 
		или имеет nil значение, если такого блока нет.
		
		tiny - это указатель на кучу.
		Тк mcache располагается в памяти вне управления сборщиком мусора
		(non-GC memory), он обрабатывается путем обнуления
		в функции releaseAll на этапе завершения маркировки 
		(mark termination).
		
		tinyAllocs - количество "крошечных" выделений,
		выполненных процессором (P),
		которому принадлежит данный mcache 
	*/
	
	tiny       uintptr  
	tinyoffset uintptr  
	tinyAllocs uintptr
	
	// Остальные поля не используются при каждом вызове malloc
	
	alloc [numSpanClasses]*mspan // блоки (spans) для выделения,
								 // индексируемые по SpanClass.
								 
	stackcache [_NumStackOrders]stackfreelist
	
	 /*
	 flushGen указывает значение sweepgen,
	 при котором данный mcache был последний раз очищен.
	 
	 Если flushGen != mheap._sweepgen,
	 то блоки (spans) в этом mcache считаются устаревшими
	 и должны быть сброшены, чтоюы их можно было очистить.
	 
	 Эта операция выполняется в функции acquirep.
	 */
	 
	 flushGen atomic.Uint32
}
```

- `{go} mstats` - статистика по выделениям памяти.

```go
type mstats struct {
	// Статистика о куче malloc.
	heapStats consistentHeapStats
	
	// Статистика о стеке.
	stacks_sys sysMemStat // считает только стек newosproc0 в mstats;
						  // отличается от MemStats.StackSys.
						  
	// Статистика выделения низкоуровневых структур.
	// фиксированного размера.
	mspan_sys    sysMemStat  
	mcache_sys   sysMemStat
	buckhash_sys sysMemStat // Хэш-таблица профилировочных бакетов.
	
	// Статистика накладных расходов GC.
	gcMiscSys sysMemStat // Обновляется атомарно 
						 // или во время STW (stop-the-world). 
						 
	// Различная статистика.
	other_sys sysMemStat // Обновляется атомарно 
						 // или во время STW (stop-the-world).
						 
	// Статистика сборщика мусора.
	
	// Защищено с помощью mheap 
	// или worldsema во время сборки мусора (GC).
	last_gc_unix    uint64 // Время последней сборки мусора 
						   // (GC) в формате Unix.
						   
	pause_total_ns  uint64
	pause_ns        [256]uint64 // Кольцевой буффер с длительностью 
								// последних пауз сборки мусора (GC).
								
	pause_end       [256]uint64 // Кольцевой буффер с временем завершения
								// последних сборок мусора (GC) 
								// в наносекундах с 1970 года.
								
	numgc           uint32  
	numforcedgc     uint32  // Количество сборок мусора 
						    // (GC), инициализированных пользователем.
	
	gc_cpu_fraction float64 // Доля времени процессора,
							// затраченного на сборку мусора (GC).
							
	last_gc_nanotime uint64 // Время последней сборки мусора
							// (GC) по монотонному таймеру.
							
	lastHeapInUse    uint64 // Объем используемой кучи (heapInUse)
							// на момент завершения фазы маркировки 
							// предыдущей сборки мусора (GC).
							
	enablegc bool
}
```

---

// TODO 1114 line in malloc.go - tiny allocator